---
title: "Project_1"
author: "Cao Fang"
date: "October 5, 2019"
output: html_document
---


```{r warning=FALSE, include=FALSE, message=FALSE}
setwd("/Users/a11/Desktop/BIOS 611")
rm(list=ls())
library(readr)
library(tidyverse)
library(dbplyr)
library(grid)
library(gridExtra)
library(lattice)
library(ggplot2)
library(tidyr)
raw <- read_tsv("UMD_Services.tsv")
raw$Date <- as.Date(raw$Date, "%m/%d/%Y")
```
###Data Source
The data is from Urban Ministries of Durham that serves homeless people various types of food and shelter services over the years
The dataset describes when each clients come in for service as well as the types of service (and the amount) they received that day. 

###Purposes
 This analysis seeks to answer few questions to help understand the pattern of service utilization 
  + What are the temporal trends in service utilization (both by amount and number of clients) ?
  + What types of service do people come in for over the years? 
  + For returning clients, what are the trend in their stay in services (how long are they staying)? 
```{r warning=FALSE, echo=FALSE}
monthyear<-raw %>%
  separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=1997) %>%group_by(year, month)%>%
  summarise(count = n_distinct(`Client File Number`))
ggplot(monthyear, aes(month, year, fill=count)) + geom_tile()+ theme_classic()

```



### What are the general trend in service utilization? 
This graph shows the count of number of distinct clients served overtime by month and year 
Overall, there isn't a clear pattern across months but a general upward trend in amount of clients served over the years 
```{r warning=FALSE, include=FALSE}
#x counting the hygiene product service overtime: the number of people who came in for this service every year (regardless of how many times)
 x <-raw %>%
  separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
   drop_na(`Hygiene Kits`) %>% filter(`Hygiene Kits`>0)%>% select(`Hygiene Kits`, `Client File Number`, year)%>%
   group_by(year)%>% filter(year>=2002)%>%summarise(hygiene = n_distinct(`Client File Number`))
#y is counting bus ticket service overtime 
  y <-raw %>%
   separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
   drop_na(`Bus Tickets (Number of)`) %>% filter(`Bus Tickets (Number of)`>0)%>% select(`Bus Tickets (Number of)`, `Client File Number`, year)%>%
   group_by(year)%>% filter(year>=2002)%>%summarise(bustix = n_distinct(`Client File Number`))
#f is counting the food services overtime 
  f <-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
    drop_na(`Food Pounds`) %>% filter(`Food Pounds`>0)%>% select(`Food Pounds`, `Client File Number`, year)%>%
    group_by(year)%>% filter(year>=2002)%>%summarise(foodpounds = n_distinct(`Client File Number`))
#m is counting the financial service overtime
  m <-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
    drop_na(`Financial Support`) %>% filter(`Financial Support`>0)%>% select(`Financial Support`, `Client File Number`, year)%>%
    group_by(year)%>% filter(year>=1997)%>%summarise(financialassistance = n_distinct(`Client File Number`))
#c is counting the clothing service 
  c <-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
    drop_na(`Clothing Items`) %>% filter(`Clothing Items`>0)%>% select(`Clothing Items`, `Client File Number`, year)%>%
    group_by(year)%>% filter(year>=2002)%>%summarise(clothing = n_distinct(`Client File Number`))
#s is counting the school kit service 
  s <-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%group_by(`Client File Number`)%>% 
    drop_na(`School Kits`) %>% filter(`School Kits`>0)%>% select(`School Kits`, `Client File Number`, year)%>%
    group_by(year)%>% filter(year>=2002)%>%summarise(school = n_distinct(`Client File Number`))
  #Number of unique client values for each year 
  unique<-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=2002) %>%group_by(year)%>%
    summarise(all = n_distinct(`Client File Number`))
um<-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=2002) %>%group_by(month)%>%
    summarise(allmonth = n_distinct(`Client File Number`))
z<-raw %>%
separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019) %>%
drop_na(`Diapers`)%>% filter(`Diapers` > 0) %>% select(`Diapers`, `Client File Number`, year)%>%
group_by(year)%>% filter(year>=2002)%>%summarise(diapers = n_distinct(`Client File Number`))%>% full_join(unique, by='year') %>%
full_join(y, by='year')%>% full_join(x, by='year')%>% full_join(f, by='year')%>% full_join(m, by='year')%>%full_join(c, by='year')%>%full_join(s, by='year')
#Gather the services and put them in one column and other for quantity of service (ignoring the quantitiy for this graph)
total <- z%>% gather(clothing, bustix, diapers, hygiene, financialassistance, foodpounds, school, key='Service', value='Quantity') %>% select("Service", "Quantity", "year")
```

```{r warning=FALSE, echo=FALSE}
ggplot(total, aes(fill=Service, y=Quantity, x=year)) + 
  geom_bar(position="stack", stat="identity")+ xlab("Year") + ylab("Number of People/Families")+ggtitle("Number of distinct clients by year and month")+scale_fill_brewer(palette = "Paired")
```


###What services are people coming in for each year?
This graph shows the number of distinct clients served by the type of service they came in for
As shown in the graph, a lot more people are now coming in for food and clothes with a small number of people also coming in for diapers. People used to come in for diapers before 2013 but the number declined sharply after 2012. In 2019, about equal number of people came in for food and clothing. 

```{r warning=FALSE, include=FALSE}
#This section calculates the frequency and time intervals between each service for clients who come in more than once 
  un<-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=1997) %>%group_by(`Client File Number`)%>%
    tally()%>%group_by(n)%>%tally()
  freq<-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=1997) %>%group_by(`Client File Number`)%>%
    tally()%>%filter(n>1)
  names(freq)[1]<-"ID"
  id<-raw %>%
    separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=1997) %>%
    select(`Client File Number`, "year")%>%group_by(`Client File Number`)
  names(id)[1]<-"ID"
freqid <- merge(freq, id, by="ID")
freqid$year <- as.numeric(freqid$year)
byfreq<- aggregate(year ~ ID , freqid, FUN = function(i)max(i) - min(i))
names(byfreq)[2]<-"Interval"
lastyear <-  aggregate(year ~ ID , freqid, FUN = function(i)max(i))%>%full_join(freq, by="ID")%>%full_join(byfreq, by="ID")
```

```{r warning=FALSE, echo=FALSE}

ggplot(lastyear, aes(year, Interval, fill=n)) + geom_tile()+ theme_classic()+scale_fill_distiller(palette = "Spectral")+
  ggtitle("Service Intervals by the last year clients came in for service")

```

###How long are clients staying in service over the years? 
This plot shows, on the x-axis the last year each client received service and on the y-axis the time window they came in for service (last year they received service-first year they received service) and the count being number of times each person came in over this their time window. Despite the bias built in to this way of presenting data, there is a slight trend that clients are staying longer in service (which is also in part due to general growth in service provided as mentioned above). Especially for those whose last year is between 2010 and 2019, people who have stayed in service longer also tend to come in for service more frequently as compared to 2000 and 2009.


```{r warning=FALSE, include=FALSE}
## average service provided each month based on amount of each product  over the years 
#(not doing them altogether because of all the NAs everywhere)
food <- raw%>% separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<2019 & year >=2005)%>% 
  drop_na( `Food Pounds`) %>% filter(`Food Pounds`>0 & `Food Pounds`<=1800)%>% select(`Food Pounds`, year, month)%>%
  group_by(year)%>%summarise(food=sum(`Food Pounds`))
diapers <- raw%>% separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<=2019 & year >=1997)%>% 
  drop_na(`Diapers`) %>% filter(`Diapers`>0 &`Diapers`<200)%>% select(`Diapers`, year, month)%>%
  group_by(year)%>%summarise(diapers=sum(`Diapers`))
cloth <- raw%>% separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<2019 & year >=2001)%>% 
  drop_na(`Clothing Items`) %>% filter(`Clothing Items`>0)%>% select(`Clothing Items`, year, month)%>%
  group_by(year)%>%summarise(clothing=sum(`Clothing Items`))
hygiene <- raw%>% separate(Date, sep="-", into = c("year", "month", "day"))%>% filter(year<2019 & year >=2002)%>% 
  drop_na(`Hygiene Kits`) %>% filter(`Hygiene Kits`>0)%>% select(`Hygiene Kits`, year, month)%>%
  group_by(year)%>%summarise(hygiene=sum(`Hygiene Kits`))
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
#plotting service by amount over the years 
ggplot(food, aes(x=year, y=food, group=1))+geom_point(color="RoyalBlue")+geom_smooth(se=FALSE)+ggtitle("Food Pounds served over the years")
ggplot(cloth, aes(x=year, y=clothing, group=1))+geom_point(color="RoyalBlue")+geom_smooth(se=FALSE)+ggtitle("Clothing served over the years")
 ggplot(diapers, aes(x=year, y=diapers, group=1))+geom_point(color="RoyalBlue")+geom_smooth(se=FALSE)+ggtitle("Diapers served over the years")
  ggplot(hygiene, aes(x=year, y=hygiene, group=1))+geom_point(color="RoyalBlue")+geom_smooth(se=FALSE)+ggtitle("Hygiene Kits served over the years")
```


###Amount of services over the years
As seen from the graphs above, food and clothing service seems to be growing steadily in demand while other services like diapers and hygiene kits have declined significantly over the years, especially after the 2008-2009 recession period.  

###Conclusions and Implications 

* It seems that demand for service is growing over the years and people tend to stay longer in service and receive service more frequently than before. Efforts are needed to find out more about why it is so. News has shared that people also tend to stay in UMD's homeless shelter longer than before (https://indyweek.com/news/durham/urban-ministries-durham-shelter-affordable-housing/). UMD should reach out and find out how to help people completely stabilize un order to eradicate homelessness. 

* In terms of types of services, UMD should also coordinate to stock more food or clothing donation as these tend to be the reasons people come in for service now more than before. 
